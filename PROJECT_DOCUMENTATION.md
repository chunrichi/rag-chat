# Outlook工单管理系统项目文档

## 1. 项目概述

Outlook工单管理系统是一个用于读取Outlook工单邮件、处理附件并与Ragflow集成的Python应用程序。该系统提供了Web界面进行配置管理、主从同步功能和Ragflow查询功能，支持图片在查询结果中显示。

## 2. 项目结构

```
/Users/lei/Desktop/bmw/bot/
├── app/
│   ├── config/          # 配置管理模块
│   ├── image/           # 图片处理模块
│   ├── outlook/         # Outlook邮件读取模块
│   ├── parser/          # 邮件内容解析模块
│   ├── static/          # 静态文件
│   ├── sync/            # 主从同步模块
│   ├── templates/       # Jinja2模板
│   └── web/             # FastAPI Web应用
├── ARCHITECTURE.md      # 架构文档
├── PROJECT_DOCUMENTATION.md # 项目文档
└── requirements.txt     # 项目依赖
```

## 3. 核心功能实现

### 3.1 Outlook邮件读取功能

**文件位置：** `app/outlook/outlook_reader.py`

- **连接管理**：
  - 支持连接到已运行的Outlook实例
  - 如果Outlook未运行，尝试启动它
  - 添加了容错处理，当Outlook未启动时不会影响整个进程

- **邮件过滤**：
  - 可以根据主题关键词过滤邮件
  - 按接收时间降序排序

- **附件处理**：
  - 支持保存邮件附件
  - 自动生成带时间戳的文件名，避免重名

- **文件夹管理**：
  - 可以获取所有邮箱文件夹
  - 支持根据路径获取特定文件夹

### 3.2 邮件内容解析功能

**文件位置：** `app/parser/email_parser.py`

- **工单信息提取**：
  - 从邮件内容中提取工单编号、客户名称、联系方式等信息
  - 使用正则表达式匹配工单字段
  - 如果没有找到工单编号，自动生成临时编号

- **数据保存**：
  - 将解析后的数据保存为JSON格式
  - 保存邮件正文为文本文件
  - 保存HTML内容（如果有）
  - 管理附件文件

- **批量处理**：
  - 支持批量解析邮件
  - 生成工单摘要信息

### 3.3 图片处理功能

**文件位置：** `app/image/image_processor.py`

- **图片压缩**：
  - 可以指定压缩质量和最大尺寸
  - 支持RGB模式转换

- **格式转换**：
  - 支持不同图片格式之间的转换
  - 处理透明背景（PNG转JPG时）

- **特征提取**：
  - 使用CLIP模型提取图片特征
  - 特征保存为npy文件

- **批量处理**：
  - 支持批量预处理图片
  - 获取图片元数据

### 3.4 Web应用功能

**文件位置：** `app/web/main.py`

- **用户界面**：
  - 配置管理界面
  - 状态显示页面
  - Ragflow查询界面

- **API接口**：
  - Outlook连接测试
  - 邮件处理触发
  - 配置管理
  - 主从同步
  - Ragflow集成

### 3.5 Ragflow集成功能

**文件位置：** `app/sync/ragflow_client.py`

- **连接管理**：
  - 测试Ragflow连接
  - 管理API密钥

- **文件上传**：
  - 支持单个文件上传
  - 支持批量文件上传
  - 自动处理图片文件

- **查询功能**：
  - 向Ragflow发送查询请求
  - 获取查询结果
  - 支持图片在结果中显示

- **数据集管理**：
  - 获取Ragflow数据集列表

### 3.6 主从同步功能

**文件位置：** `app/sync/master_sync.py` 和 `app/sync/slave_sync.py`

- **主应用功能**：
  - 接收从应用的同步数据
  - 管理多个从应用
  - 生成同步报告

- **从应用功能**：
  - 定期收集本地Outlook信息
  - 发送数据到主应用
  - 维护同步状态

## 4. 技术栈

- **Python 3.9+**：项目开发语言
- **FastAPI**：Web框架
- **Jinja2**：模板引擎
- **pywin32**：Outlook操作（Windows平台）
- **Pillow**：图片处理
- **Transformers**：CLIP模型（图片特征提取）
- **Pydantic**：数据验证和配置管理
- **Requests**：HTTP请求

## 5. 使用方法

### 5.1 启动Web应用

```bash
python3 -m app.web.main
```

应用将在 `http://localhost:8000` 启动。

### 5.2 配置管理

1. 访问 `http://localhost:8000/config`
2. 配置Outlook参数
3. 配置Ragflow URL和API Key
4. 配置Web服务器设置
5. 选择应用模式（独立、主应用或从应用）

### 5.3 Ragflow查询

1. 访问 `http://localhost:8000/ragflow`
2. 在查询框中输入问题
3. 选择结果数量
4. 点击查询按钮
5. 查看查询结果，包括图片

### 5.4 同步管理

- **主应用**：访问 `http://localhost:8000/status` 查看同步状态和报告
- **从应用**：自动与主应用同步数据

## 6. 容错处理

- **Outlook容错**：当Outlook未启动时，系统会返回空邮件列表或模拟数据，不会影响整个进程
- **网络容错**：处理网络连接失败的情况
- **文件操作容错**：处理文件读写失败的情况
- **API容错**：处理API调用失败的情况

## 7. 图片显示功能

- 支持多种图片格式（JPG、PNG、GIF等）
- 图片在查询结果中直接显示，不是隐藏的
- 支持相对路径和绝对路径
- 可以处理不同格式的图片路径表示

## 8. 功能总结

根据项目实现情况，所有要求的功能都已实现：

- ✅ Outlook容错处理（未启动时不影响整个进程）
- ✅ FastAPI接口和前端用于维护Ragflow地址信息
- ✅ 显示同步状态
- ✅ 上传Outlook整理出来的文件到Ragflow
- ✅ Ragflow查询和结果展示界面
- ✅ 图片在结果中显示（不是隐藏）

## 9. 扩展建议

- 添加用户认证功能
- 支持更多邮件客户端
- 增加数据可视化功能
- 优化图片处理性能
- 支持更多向量数据库

## 10. 联系方式

如有问题或建议，请联系项目开发团队。